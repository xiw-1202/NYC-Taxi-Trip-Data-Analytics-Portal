<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NYC Taxi Data Analytics Portal</title>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .feature-section {
            margin-bottom: 40px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .feature-title {
            color: #667eea;
            font-size: 1.8em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .feature-number {
            background: #667eea;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .feature-description {
            background: #e8eaf6;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .feature-description h4 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .feature-description p {
            color: #555;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .insight {
            background: #fff3cd;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            border-left: 4px solid #ffc107;
        }

        .insight strong {
            color: #856404;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 15px;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #667eea;
            color: white;
            font-weight: bold;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .metric-box {
            background: #f0f4ff;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #667eea;
        }

        .metric-box .value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .metric-box .label {
            font-size: 0.9em;
            color: #666;
        }

        .tab-container {
            margin-bottom: 30px;
        }

        .tab-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .tab-button {
            padding: 12px 24px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            color: #667eea;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 150px;
        }

        .tab-button:hover {
            background: #e8eaf6;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.2);
        }

        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .unified-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            min-height: 500px;
        }

        .region-comparison-controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .region-comparison-controls h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .region-controls-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: flex-end;
            margin-bottom: 15px;
        }

        .region-control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex: 1;
            min-width: 200px;
        }

        .region-control-group label {
            font-size: 0.9em;
            color: #666;
            font-weight: 600;
        }

        .region-control-group select {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            background: white;
            color: #333;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .region-control-group select:hover {
            border-color: #667eea;
        }

        .region-control-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .compare-button {
            padding: 10px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            white-space: nowrap;
        }

        .compare-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .compare-button:active {
            transform: translateY(0);
        }

        .comparison-results {
            margin-top: 20px;
            padding: 20px;
            background: #e8f4fd;
            border-left: 4px solid #2196F3;
            border-radius: 8px;
            display: none;
        }

        .comparison-results.active {
            display: block;
        }

        .comparison-results h4 {
            color: #1976D2;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .comparison-table th {
            background: #2196F3;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .comparison-table td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }

        .comparison-table tr:last-child td {
            border-bottom: none;
        }

        .comparison-table tr:hover {
            background: #f5f5f5;
        }

        .comparison-metric {
            font-weight: 600;
            color: #333;
        }

        .comparison-value {
            text-align: right;
        }

        .comparison-diff {
            text-align: right;
            font-weight: 600;
        }

        .comparison-diff.positive {
            color: #4caf50;
        }

        .comparison-diff.negative {
            color: #f44336;
        }

        .comparison-diff.neutral {
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöï NYC Taxi Data Analytics Portal</h1>
            <div class="subtitle">
                CS 554 - Database Systems | 24M+ Manhattan Taxi Trips (Jan-Oct 2025)
            </div>
        </header>

        <!-- Overall Statistics -->
        <div id="overall-stats" class="stats-grid"></div>

        <!-- Unified Feature Section with Tabs -->
        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab(1)">1. Zone Popularity</button>
                <button class="tab-button" onclick="switchTab(2)">2. Temporal Demand</button>
                <button class="tab-button" onclick="switchTab(3)">3. Fare Structure</button>
                <button class="tab-button" onclick="switchTab(4)">4. Airport Trips</button>
                <button class="tab-button" onclick="switchTab(5)">5. OD Flows</button>
                <button class="tab-button" onclick="switchTab(6)">6. Vendor Performance</button>
                <button class="tab-button" onclick="switchTab(7)">7. Payment & Tipping</button>
                <button class="tab-button" onclick="switchTab(8)">8. Anomalies</button>
            </div>

            <div class="unified-section">
                <!-- Tab 1: Zone Popularity -->
                <div id="tab-1" class="tab-content active">
                    <div class="feature-title">
                        <span class="feature-number">1</span>
                        Zone Popularity Ranking - Spatial Demand Analysis
                    </div>
                    <div class="feature-description">
                        <h4>üìç What This Shows</h4>
                        <p>Identifies Manhattan's most active taxi zones by analyzing pickup and dropoff volumes. This reveals urban mobility hotspots, business districts, and residential commuter patterns.</p>
                        <div class="insight">
                            <strong>Business Value:</strong> Fleet operators can optimize vehicle positioning, urban planners can identify high-demand areas for infrastructure investment, and real estate developers can assess location desirability.
                        </div>
                    </div>
                    
                    <!-- Region Comparison Controls -->
                    <div class="region-comparison-controls">
                        <h3>üåç Zone Comparison</h3>
                        <div class="region-controls-row">
                            <div class="region-control-group">
                                <label for="zone1-select">Select Zone 1:</label>
                                <select id="zone1-select">
                                    <option value="">-- Select Zone --</option>
                                </select>
                            </div>
                            <div class="region-control-group">
                                <label for="zone2-select">Select Zone 2:</label>
                                <select id="zone2-select">
                                    <option value="">-- Select Zone --</option>
                                </select>
                            </div>
                            <div class="region-control-group">
                                <label>&nbsp;</label>
                                <button class="compare-button" onclick="compareZones(1)">Compare Zones</button>
                            </div>
                        </div>
                        <div id="zone-comparison-results" class="comparison-results">
                            <h4>üìä Zone Comparison Results</h4>
                            <div id="zone-comparison-content"></div>
                        </div>
                    </div>

                    <div class="chart-container" id="zone-chart"></div>
                    <div class="chart-container" id="zone-comparison"></div>
                </div>

                <!-- Tab 2: Temporal Demand -->
                <div id="tab-2" class="tab-content">
                    <div class="feature-title">
                        <span class="feature-number">2</span>
                        Temporal Demand Patterns - Time-Series Analysis
                    </div>
                    <div class="feature-description">
                        <h4>‚è∞ What This Shows</h4>
                        <p>Analyzes how taxi demand varies by hour and day of week, revealing commute patterns, nightlife activity, and weekend vs. weekday behavior differences.</p>
                        <div class="insight">
                            <strong>Key Finding:</strong> Rush hour peaks (8-9 AM, 6-7 PM) show 2-3x higher demand than off-peak hours. Weekend demand peaks later (10 PM-2 AM) due to nightlife activity.
                        </div>
                    </div>
                    <div class="chart-container" id="temporal-hourly"></div>
                    <div class="chart-container" id="temporal-heatmap"></div>
                </div>

                <!-- Tab 3: Fare Structure -->
                <div id="tab-3" class="tab-content">
                    <div class="feature-title">
                        <span class="feature-number">3</span>
                        Fare Structure Breakdown - Economic Component Analysis
                    </div>
                    <div class="feature-description">
                        <h4>üí∞ What This Shows</h4>
                        <p>Decomposes total fare into individual components (base fare, tips, taxes, surcharges) to understand cost structure and government revenue streams.</p>
                        <div class="insight">
                            <strong>Economic Impact:</strong> Surcharges (congestion, MTA tax, improvement fee) represent 15-20% of total fare, generating significant public revenue while influencing customer pricing perception.
                        </div>
                    </div>
                    <div class="chart-container" id="fare-pie"></div>
                    <div class="chart-container" id="fare-surcharges"></div>
                </div>

                <!-- Tab 4: Airport Trips -->
                <div id="tab-4" class="tab-content">
                    <div class="feature-title">
                        <span class="feature-number">4</span>
                        Airport Trip Analysis - Hub Connectivity Study
                    </div>
                    <div class="feature-description">
                        <h4>‚úàÔ∏è What This Shows</h4>
                        <p>Compares airport trips (JFK, LGA, EWR) vs. regular Manhattan trips, analyzing volume, fares, distances, and origin zones for airport passengers.</p>
                        <div class="insight">
                            <strong>Travel Pattern:</strong> Airport trips have 3-4x higher average fares ($50-65 vs. $15-18) and originate primarily from Midtown hotels and business districts.
                        </div>
                    </div>
                    
                    <!-- Region Comparison Controls -->
                    <div class="region-comparison-controls">
                        <h3>üåç Zone Comparison for Airport Trips</h3>
                        <div class="region-controls-row">
                            <div class="region-control-group">
                                <label for="airport-zone1-select">Select Zone 1:</label>
                                <select id="airport-zone1-select">
                                    <option value="">-- Select Zone --</option>
                                </select>
                            </div>
                            <div class="region-control-group">
                                <label for="airport-zone2-select">Select Zone 2:</label>
                                <select id="airport-zone2-select">
                                    <option value="">-- Select Zone --</option>
                                </select>
                            </div>
                            <div class="region-control-group">
                                <label>&nbsp;</label>
                                <button class="compare-button" onclick="compareZones(4)">Compare Zones</button>
                            </div>
                        </div>
                        <div id="airport-comparison-results" class="comparison-results">
                            <h4>üìä Airport Trip Zone Comparison Results</h4>
                            <div id="airport-comparison-content"></div>
                        </div>
                    </div>

                    <div class="chart-container" id="airport-comparison"></div>
                    <div class="chart-container" id="airport-origins"></div>
                </div>

                <!-- Tab 5: OD Flows -->
                <div id="tab-5" class="tab-content">
                    <div class="feature-title">
                        <span class="feature-number">5</span>
                        Origin-Destination Flow Patterns - Route Network Analysis
                    </div>
                    <div class="feature-description">
                        <h4>üîÑ What This Shows</h4>
                        <p>Maps the most common taxi routes between Manhattan neighborhoods, revealing commuting corridors, tourism patterns, and intra-borough mobility. Analyzes route characteristics including distance, duration, and efficiency metrics.</p>
                        <div class="insight">
                            <strong>Network Effect:</strong> Top routes show strong intra-neighborhood patterns (same-zone trips dominate), north-south commuter corridors between UES and Midtown, and efficiency variations based on traffic and distance.
                        </div>
                    </div>
                    
                    <!-- Region Comparison Controls -->
                    <div class="region-comparison-controls">
                        <h3>üåç Route Comparison</h3>
                        <div class="region-controls-row">
                            <div class="region-control-group">
                                <label for="od-zone1-select">Select Origin Zone 1:</label>
                                <select id="od-zone1-select">
                                    <option value="">-- Select Zone --</option>
                                </select>
                            </div>
                            <div class="region-control-group">
                                <label for="od-zone2-select">Select Origin Zone 2:</label>
                                <select id="od-zone2-select">
                                    <option value="">-- Select Zone --</option>
                                </select>
                            </div>
                            <div class="region-control-group">
                                <label>&nbsp;</label>
                                <button class="compare-button" onclick="compareZones(5)">Compare Routes</button>
                            </div>
                        </div>
                        <div id="od-comparison-results" class="comparison-results">
                            <h4>üìä Route Comparison Results</h4>
                            <div id="od-comparison-content"></div>
                        </div>
                    </div>

                    <div class="chart-container" id="od-table"></div>
                    <div class="chart-container" id="od-flow-analysis"></div>
                </div>

                <!-- Tab 6: Vendor Performance -->
                <div id="tab-6" class="tab-content">
                    <div class="feature-title">
                        <span class="feature-number">6</span>
                        Vendor Market Share & Performance - Competitive Analysis
                    </div>
                    <div class="feature-description">
                        <h4>üè¢ What This Shows</h4>
                        <p>Compares taxi vendors (CMT vs. VeriFone) by market share, service quality metrics (avg fare, distance, duration), and operational efficiency.</p>
                        <div class="insight">
                            <strong>Market Dynamics:</strong> VeriFone dominates with 75-80% market share. Performance metrics are remarkably similar across vendors, suggesting standardized service quality and regulated pricing.
                        </div>
                    </div>
                    <div class="chart-container" id="vendor-market"></div>
                    <div class="chart-container" id="vendor-performance"></div>
                </div>

                <!-- Tab 7: Payment & Tipping -->
                <div id="tab-7" class="tab-content">
                    <div class="feature-title">
                        <span class="feature-number">7</span>
                        Payment Method & Tipping Behavior - Transaction Psychology
                    </div>
                    <div class="feature-description">
                        <h4>üí≥ What This Shows</h4>
                        <p>Analyzes payment method distribution (credit card, cash, dispute, no charge) and their impact on tipping behavior. Shows how digital payments influence gratuity patterns and driver income.</p>
                        <div class="insight">
                            <strong>Behavioral Economics:</strong> Credit card users tip in 95% of trips with 26.5% average tip rate, while cash payments show 0% recorded tips. Payment method choice has dramatic impact on driver earnings.
                        </div>
                    </div>
                    <div class="chart-container" id="payment-distribution"></div>
                    <div class="chart-container" id="payment-analysis"></div>
                </div>

                <!-- Tab 8: Anomalies -->
                <div id="tab-8" class="tab-content">
                    <div class="feature-title">
                        <span class="feature-number">8</span>
                        Outlier & Anomaly Detection - Data Quality & Edge Cases
                    </div>
                    <div class="feature-description">
                        <h4>üîç What This Shows</h4>
                        <p>Identifies unusual trips (abnormally high fares, suspicious routes, data quality issues) using statistical outlier detection methods.</p>
                        <div class="insight">
                            <strong>Quality Control:</strong> 2-4% of trips show anomalies including surge pricing ($50+/mile), data entry errors, or special circumstances (emergencies, VIP service). Critical for data cleaning and fraud detection.
                        </div>
                    </div>
                    <div class="chart-container" id="anomaly-summary"></div>
                    <div class="chart-container" id="anomaly-examples"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';

        // Tab switching function
        function switchTab(tabNumber) {
            // Hide all tab contents
            for (let i = 1; i <= 8; i++) {
                document.getElementById(`tab-${i}`).classList.remove('active');
                document.querySelectorAll('.tab-button')[i - 1].classList.remove('active');
            }
            
            // Show selected tab
            document.getElementById(`tab-${tabNumber}`).classList.add('active');
            document.querySelectorAll('.tab-button')[tabNumber - 1].classList.add('active');
        }

        // Helper functions
        function formatNumber(num) {
            return new Intl.NumberFormat('en-US').format(num);
        }

        function formatCurrency(num) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(num);
        }

        // Load overall statistics
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                const data = await response.json();

                document.getElementById('overall-stats').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${formatNumber(data.total_trips)}</div>
                        <div class="stat-label">Total Trips</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${formatCurrency(data.avg_fare)}</div>
                        <div class="stat-label">Avg Fare</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${data.avg_distance} mi</div>
                        <div class="stat-label">Avg Distance</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${data.avg_duration_min} min</div>
                        <div class="stat-label">Avg Duration</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${formatCurrency(data.total_revenue)}</div>
                        <div class="stat-label">Total Revenue</div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('overall-stats').innerHTML =
                    `<div class="error">Error loading statistics. Make sure the backend is running on port 8000.</div>`;
            }
        }

        // Feature 1: Zone Popularity - Enhanced with pickup/dropoff comparison
        async function loadZoneData() {
            try {
                // Load top pickup zones
                const pickupResponse = await fetch(`${API_BASE}/api/zones/top-pickup?limit=15`);
                const pickupData = await pickupResponse.json();

                // Load top dropoff zones
                const dropoffResponse = await fetch(`${API_BASE}/api/zones/top-dropoff?limit=15`);
                const dropoffData = await dropoffResponse.json();

                // Main chart: Top pickup zones
                const zones = pickupData.zones.map(z => z.zone);
                const counts = pickupData.zones.map(z => z.pickup_count);

                const trace1 = {
                    x: counts,
                    y: zones,
                    type: 'bar',
                    orientation: 'h',
                    marker: {
                        color: counts,
                        colorscale: 'Viridis',
                        showscale: true,
                        colorbar: { title: 'Trips' }
                    },
                    text: counts.map(c => formatNumber(c)),
                    textposition: 'outside'
                };

                const layout1 = {
                    title: 'Top 15 Pickup Zones by Trip Volume',
                    xaxis: { title: 'Number of Pickups' },
                    yaxis: { title: '', automargin: true },
                    height: 600,
                    margin: { l: 200, r: 100 }
                };

                Plotly.newPlot('zone-chart', [trace1], layout1);

                // Comparison chart
                const comparisonHTML = `
                    <h3>Pickup vs. Dropoff Zone Comparison</h3>
                    <div class="metric-grid">
                        <div class="metric-box">
                            <div class="value">${pickupData.zones[0].zone}</div>
                            <div class="label">Most Popular Pickup</div>
                        </div>
                        <div class="metric-box">
                            <div class="value">${formatNumber(pickupData.zones[0].pickup_count)}</div>
                            <div class="label">Top Zone Trips</div>
                        </div>
                        <div class="metric-box">
                            <div class="value">${dropoffData.zones[0].zone}</div>
                            <div class="label">Most Popular Dropoff</div>
                        </div>
                        <div class="metric-box">
                            <div class="value">${formatCurrency(pickupData.zones[0].avg_fare)}</div>
                            <div class="label">Avg Fare (Top Zone)</div>
                        </div>
                    </div>
                `;

                document.getElementById('zone-comparison').innerHTML = comparisonHTML;

                // Populate zone selectors for comparison
                populateZoneSelectors(pickupData.zones, ['zone1-select', 'zone2-select']);

            } catch (error) {
                document.getElementById('zone-chart').innerHTML =
                    `<div class="error">Error loading zone data: ${error.message}</div>`;
            }
        }

        // Populate zone selectors with available zones
        function populateZoneSelectors(zones, selectIds) {
            selectIds.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    // Keep the first option (placeholder)
                    const firstOption = select.options[0];
                    select.innerHTML = '';
                    select.appendChild(firstOption);
                    
                    // Add zones
                    zones.forEach(zone => {
                        const option = document.createElement('option');
                        option.value = zone.zone;
                        option.textContent = zone.zone;
                        select.appendChild(option);
                    });
                }
            });
        }

        // Compare zones function
        async function compareZones(tabNumber) {
            let zone1Select, zone2Select, resultsDiv, contentDiv;
            
            if (tabNumber === 1) {
                zone1Select = document.getElementById('zone1-select');
                zone2Select = document.getElementById('zone2-select');
                resultsDiv = document.getElementById('zone-comparison-results');
                contentDiv = document.getElementById('zone-comparison-content');
            } else if (tabNumber === 4) {
                zone1Select = document.getElementById('airport-zone1-select');
                zone2Select = document.getElementById('airport-zone2-select');
                resultsDiv = document.getElementById('airport-comparison-results');
                contentDiv = document.getElementById('airport-comparison-content');
            } else if (tabNumber === 5) {
                zone1Select = document.getElementById('od-zone1-select');
                zone2Select = document.getElementById('od-zone2-select');
                resultsDiv = document.getElementById('od-comparison-results');
                contentDiv = document.getElementById('od-comparison-content');
            } else {
                return;
            }

            const zone1 = zone1Select.value;
            const zone2 = zone2Select.value;

            if (!zone1 || !zone2) {
                alert('Please select both zones to compare.');
                return;
            }

            if (zone1 === zone2) {
                alert('Please select two different zones.');
                return;
            }

            try {
                let zone1Data, zone2Data;

                if (tabNumber === 1) {
                    // Zone Popularity comparison
                    const pickupResponse = await fetch(`${API_BASE}/api/zones/top-pickup?limit=100`);
                    const pickupData = await pickupResponse.json();
                    
                    zone1Data = pickupData.zones.find(z => z.zone === zone1);
                    zone2Data = pickupData.zones.find(z => z.zone === zone2);

                    if (!zone1Data || !zone2Data) {
                        throw new Error('Zone data not found');
                    }

                    const comparisonHTML = `
                        <table class="comparison-table">
                            <tr>
                                <th>Metric</th>
                                <th>${zone1}</th>
                                <th>${zone2}</th>
                                <th>Difference</th>
                            </tr>
                            <tr>
                                <td class="comparison-metric">Pickup Count</td>
                                <td class="comparison-value">${formatNumber(zone1Data.pickup_count)}</td>
                                <td class="comparison-value">${formatNumber(zone2Data.pickup_count)}</td>
                                <td class="comparison-diff ${zone1Data.pickup_count > zone2Data.pickup_count ? 'positive' : 'negative'}">
                                    ${zone1Data.pickup_count > zone2Data.pickup_count ? '+' : ''}${formatNumber(zone1Data.pickup_count - zone2Data.pickup_count)}
                                </td>
                            </tr>
                            <tr>
                                <td class="comparison-metric">Average Fare</td>
                                <td class="comparison-value">${formatCurrency(zone1Data.avg_fare)}</td>
                                <td class="comparison-value">${formatCurrency(zone2Data.avg_fare)}</td>
                                <td class="comparison-diff ${zone1Data.avg_fare > zone2Data.avg_fare ? 'positive' : 'negative'}">
                                    ${zone1Data.avg_fare > zone2Data.avg_fare ? '+' : ''}${formatCurrency(zone1Data.avg_fare - zone2Data.avg_fare)}
                                </td>
                            </tr>
                            <tr>
                                <td class="comparison-metric">Average Distance</td>
                                <td class="comparison-value">${zone1Data.avg_distance} mi</td>
                                <td class="comparison-value">${zone2Data.avg_distance} mi</td>
                                <td class="comparison-diff ${zone1Data.avg_distance > zone2Data.avg_distance ? 'positive' : 'negative'}">
                                    ${zone1Data.avg_distance > zone2Data.avg_distance ? '+' : ''}${(zone1Data.avg_distance - zone2Data.avg_distance).toFixed(2)} mi
                                </td>
                            </tr>
                            <tr>
                                <td class="comparison-metric">Median Fare</td>
                                <td class="comparison-value">${formatCurrency(zone1Data.median_fare || 0)}</td>
                                <td class="comparison-value">${formatCurrency(zone2Data.median_fare || 0)}</td>
                                <td class="comparison-diff ${(zone1Data.median_fare || 0) > (zone2Data.median_fare || 0) ? 'positive' : 'negative'}">
                                    ${(zone1Data.median_fare || 0) > (zone2Data.median_fare || 0) ? '+' : ''}${formatCurrency((zone1Data.median_fare || 0) - (zone2Data.median_fare || 0))}
                                </td>
                            </tr>
                        </table>
                    `;
                    contentDiv.innerHTML = comparisonHTML;

                } else if (tabNumber === 4) {
                    // Airport Trips comparison
                    const originsResponse = await fetch(`${API_BASE}/api/airport/top-origins?limit=100`);
                    const originsData = await originsResponse.json();
                    
                    zone1Data = originsData.top_origins.find(z => z.zone === zone1);
                    zone2Data = originsData.top_origins.find(z => z.zone === zone2);

                    if (!zone1Data || !zone2Data) {
                        throw new Error('Zone data not found for airport trips');
                    }

                    const comparisonHTML = `
                        <table class="comparison-table">
                            <tr>
                                <th>Metric</th>
                                <th>${zone1}</th>
                                <th>${zone2}</th>
                                <th>Difference</th>
                            </tr>
                            <tr>
                                <td class="comparison-metric">Airport Trip Count</td>
                                <td class="comparison-value">${formatNumber(zone1Data.trip_count)}</td>
                                <td class="comparison-value">${formatNumber(zone2Data.trip_count)}</td>
                                <td class="comparison-diff ${zone1Data.trip_count > zone2Data.trip_count ? 'positive' : 'negative'}">
                                    ${zone1Data.trip_count > zone2Data.trip_count ? '+' : ''}${formatNumber(zone1Data.trip_count - zone2Data.trip_count)}
                                </td>
                            </tr>
                            <tr>
                                <td class="comparison-metric">Average Fare</td>
                                <td class="comparison-value">${formatCurrency(zone1Data.avg_fare)}</td>
                                <td class="comparison-value">${formatCurrency(zone2Data.avg_fare)}</td>
                                <td class="comparison-diff ${zone1Data.avg_fare > zone2Data.avg_fare ? 'positive' : 'negative'}">
                                    ${zone1Data.avg_fare > zone2Data.avg_fare ? '+' : ''}${formatCurrency(zone1Data.avg_fare - zone2Data.avg_fare)}
                                </td>
                            </tr>
                            <tr>
                                <td class="comparison-metric">Average Distance</td>
                                <td class="comparison-value">${zone1Data.avg_distance} mi</td>
                                <td class="comparison-value">${zone2Data.avg_distance} mi</td>
                                <td class="comparison-diff ${zone1Data.avg_distance > zone2Data.avg_distance ? 'positive' : 'negative'}">
                                    ${zone1Data.avg_distance > zone2Data.avg_distance ? '+' : ''}${(zone1Data.avg_distance - zone2Data.avg_distance).toFixed(2)} mi
                                </td>
                            </tr>
                        </table>
                    `;
                    contentDiv.innerHTML = comparisonHTML;

                } else if (tabNumber === 5) {
                    // OD Flows comparison - compare routes from two origin zones
                    const routesResponse = await fetch(`${API_BASE}/api/od-flows/top-routes?limit=200`);
                    const routesData = await routesResponse.json();
                    
                    // Get all routes from zone1 and zone2
                    const zone1Routes = routesData.top_routes.filter(r => r.origin === zone1);
                    const zone2Routes = routesData.top_routes.filter(r => r.origin === zone2);

                    if (zone1Routes.length === 0 || zone2Routes.length === 0) {
                        throw new Error('No route data found for selected zones');
                    }

                    // Calculate aggregate metrics
                    const zone1Total = zone1Routes.reduce((sum, r) => sum + r.trip_count, 0);
                    const zone2Total = zone2Routes.reduce((sum, r) => sum + r.trip_count, 0);
                    const zone1AvgFare = zone1Routes.reduce((sum, r) => sum + r.avg_fare, 0) / zone1Routes.length;
                    const zone2AvgFare = zone2Routes.reduce((sum, r) => sum + r.avg_fare, 0) / zone2Routes.length;
                    const zone1AvgDistance = zone1Routes.reduce((sum, r) => sum + r.avg_distance, 0) / zone1Routes.length;
                    const zone2AvgDistance = zone2Routes.reduce((sum, r) => sum + r.avg_distance, 0) / zone2Routes.length;
                    const zone1AvgDuration = zone1Routes.reduce((sum, r) => sum + r.avg_duration_min, 0) / zone1Routes.length;
                    const zone2AvgDuration = zone2Routes.reduce((sum, r) => sum + r.avg_duration_min, 0) / zone2Routes.length;

                    const comparisonHTML = `
                        <table class="comparison-table">
                            <tr>
                                <th>Metric</th>
                                <th>${zone1} (Origin)</th>
                                <th>${zone2} (Origin)</th>
                                <th>Difference</th>
                            </tr>
                            <tr>
                                <td class="comparison-metric">Total Routes</td>
                                <td class="comparison-value">${zone1Routes.length}</td>
                                <td class="comparison-value">${zone2Routes.length}</td>
                                <td class="comparison-diff ${zone1Routes.length > zone2Routes.length ? 'positive' : 'negative'}">
                                    ${zone1Routes.length > zone2Routes.length ? '+' : ''}${zone1Routes.length - zone2Routes.length}
                                </td>
                            </tr>
                            <tr>
                                <td class="comparison-metric">Total Trip Count</td>
                                <td class="comparison-value">${formatNumber(zone1Total)}</td>
                                <td class="comparison-value">${formatNumber(zone2Total)}</td>
                                <td class="comparison-diff ${zone1Total > zone2Total ? 'positive' : 'negative'}">
                                    ${zone1Total > zone2Total ? '+' : ''}${formatNumber(zone1Total - zone2Total)}
                                </td>
                            </tr>
                            <tr>
                                <td class="comparison-metric">Average Fare</td>
                                <td class="comparison-value">${formatCurrency(zone1AvgFare)}</td>
                                <td class="comparison-value">${formatCurrency(zone2AvgFare)}</td>
                                <td class="comparison-diff ${zone1AvgFare > zone2AvgFare ? 'positive' : 'negative'}">
                                    ${zone1AvgFare > zone2AvgFare ? '+' : ''}${formatCurrency(zone1AvgFare - zone2AvgFare)}
                                </td>
                            </tr>
                            <tr>
                                <td class="comparison-metric">Average Distance</td>
                                <td class="comparison-value">${zone1AvgDistance.toFixed(2)} mi</td>
                                <td class="comparison-value">${zone2AvgDistance.toFixed(2)} mi</td>
                                <td class="comparison-diff ${zone1AvgDistance > zone2AvgDistance ? 'positive' : 'negative'}">
                                    ${zone1AvgDistance > zone2AvgDistance ? '+' : ''}${(zone1AvgDistance - zone2AvgDistance).toFixed(2)} mi
                                </td>
                            </tr>
                            <tr>
                                <td class="comparison-metric">Average Duration</td>
                                <td class="comparison-value">${zone1AvgDuration.toFixed(1)} min</td>
                                <td class="comparison-value">${zone2AvgDuration.toFixed(1)} min</td>
                                <td class="comparison-diff ${zone1AvgDuration > zone2AvgDuration ? 'negative' : 'positive'}">
                                    ${zone1AvgDuration > zone2AvgDuration ? '+' : ''}${(zone1AvgDuration - zone2AvgDuration).toFixed(1)} min
                                </td>
                            </tr>
                        </table>
                    `;
                    contentDiv.innerHTML = comparisonHTML;
                }

                // Show results
                resultsDiv.classList.add('active');

            } catch (error) {
                alert(`Error comparing zones: ${error.message}`);
                console.error('Comparison error:', error);
            }
        }

        // Feature 2: Temporal Demand - Enhanced with heatmap
        async function loadTemporalData() {
            try {
                // Hourly demand
                const hourlyResponse = await fetch(`${API_BASE}/api/temporal/hourly`);
                const hourlyData = await hourlyResponse.json();

                const hours = hourlyData.hourly_data.map(h => h.hour);
                const trips = hourlyData.hourly_data.map(h => h.total_trips);
                const avgFares = hourlyData.hourly_data.map(h => h.avg_fare);

                const trace1 = {
                    x: hours,
                    y: trips,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Trip Count',
                    line: { color: '#667eea', width: 3 },
                    marker: { size: 8 },
                    yaxis: 'y'
                };

                const trace2 = {
                    x: hours,
                    y: avgFares,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Avg Fare',
                    line: { color: '#764ba2', width: 3 },
                    marker: { size: 8 },
                    yaxis: 'y2'
                };

                const layout1 = {
                    title: 'Hourly Trip Demand and Fare Patterns',
                    xaxis: { title: 'Hour of Day (0-23)' },
                    yaxis: {
                        title: 'Number of Trips',
                        side: 'left'
                    },
                    yaxis2: {
                        title: 'Average Fare ($)',
                        side: 'right',
                        overlaying: 'y'
                    },
                    height: 400,
                    showlegend: true
                };

                Plotly.newPlot('temporal-hourly', [trace1, trace2], layout1);

                // Heatmap - FIXED: Use correct field names
                const heatmapResponse = await fetch(`${API_BASE}/api/temporal/heatmap`);
                const heatmapData = await heatmapResponse.json();

                const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                const hoursArr = Array.from({length: 24}, (_, i) => i);

                // Create matrix with correct data structure
                const heatmapMatrix = dayNames.map((_, dayIdx) => {
                    return hoursArr.map(hour => {
                        const cell = heatmapData.heatmap_data.find(d => d.day === dayIdx && d.hour === hour);
                        return cell ? cell.trips : 0;
                    });
                });

                const traceHeatmap = {
                    z: heatmapMatrix,
                    x: hoursArr,
                    y: dayNames,
                    type: 'heatmap',
                    colorscale: [
                        [0, '#440154'],
                        [0.25, '#31688e'],
                        [0.5, '#35b779'],
                        [0.75, '#fde724'],
                        [1, '#fde724']
                    ],
                    colorbar: { title: 'Trip Count' }
                };

                const layout2 = {
                    title: 'Trip Demand Heatmap: Day √ó Hour',
                    xaxis: { title: 'Hour of Day' },
                    yaxis: { title: 'Day of Week' },
                    height: 400
                };

                Plotly.newPlot('temporal-heatmap', [traceHeatmap], layout2);

            } catch (error) {
                document.getElementById('temporal-hourly').innerHTML =
                    `<div class="error">Error loading temporal data: ${error.message}</div>`;
            }
        }

        // Feature 3: Fare Structure - FIXED surcharge data
        async function loadFareData() {
            try {
                const response = await fetch(`${API_BASE}/api/fare-structure/breakdown`);
                const data = await response.json();

                // Pie chart
                const components = [
                    'Base Fare', 'Tip', 'Tolls', 'MTA Tax',
                    'Congestion', 'Extra', 'Improvement', 'Airport Fee'
                ];
                const values = [
                    data.components.base_fare,
                    data.components.tip,
                    data.components.tolls,
                    data.components.mta_tax,
                    data.components.congestion_surcharge,
                    data.components.extra,
                    data.components.improvement_surcharge,
                    data.components.airport_fee
                ];

                const tracePie = {
                    labels: components,
                    values: values,
                    type: 'pie',
                    marker: {
                        colors: ['#667eea', '#764ba2', '#f093fb', '#4facfe',
                                '#00f2fe', '#43e97b', '#fa709a', '#fee140']
                    },
                    textinfo: 'label+percent',
                    textposition: 'outside'
                };

                const layout1 = {
                    title: 'Average Fare Component Breakdown',
                    height: 500
                };

                Plotly.newPlot('fare-pie', [tracePie], layout1);

                // Surcharge analysis - FIXED: Use correct field names
                const surchargeResponse = await fetch(`${API_BASE}/api/fare-structure/surcharges`);
                const surchargeData = await surchargeResponse.json();

                const surchargeHTML = `
                    <h3>Surcharge Impact Analysis</h3>
                    <div class="metric-grid">
                        <div class="metric-box">
                            <div class="value">${formatNumber(surchargeData.surcharge_counts.congestion)}</div>
                            <div class="label">Congestion Surcharge Trips</div>
                        </div>
                        <div class="metric-box">
                            <div class="value">${surchargeData.surcharge_percentages.congestion}%</div>
                            <div class="label">Congestion Surcharge %</div>
                        </div>
                        <div class="metric-box">
                            <div class="value">${formatNumber(surchargeData.surcharge_counts.tolls)}</div>
                            <div class="label">Tolls Applied</div>
                        </div>
                        <div class="metric-box">
                            <div class="value">${formatNumber(surchargeData.surcharge_counts.airport_fee)}</div>
                            <div class="label">Airport Fee Trips</div>
                        </div>
                    </div>
                    <p style="margin-top: 15px; color: #666;">
                        <strong>Revenue Impact:</strong> Surcharges contribute approximately $${
                            (data.components.mta_tax + data.components.congestion_surcharge +
                             data.components.improvement_surcharge + data.components.airport_fee).toFixed(2)
                        } per trip on average, generating substantial public revenue for transportation infrastructure. ${surchargeData.surcharge_percentages.congestion}% of trips include congestion surcharge.
                    </p>
                `;

                document.getElementById('fare-surcharges').innerHTML = surchargeHTML;

            } catch (error) {
                document.getElementById('fare-pie').innerHTML =
                    `<div class="error">Error loading fare data: ${error.message}</div>`;
            }
        }

        // Feature 4: Airport Trips - FIXED field names
        async function loadAirportData() {
            try {
                const response = await fetch(`${API_BASE}/api/airport/comparison`);
                const data = await response.json();

                const types = data.comparison.map(c => c.trip_type);
                const counts = data.comparison.map(c => c.trip_count);
                const fares = data.comparison.map(c => c.avg_fare);

                const trace1 = {
                    x: types,
                    y: counts,
                    type: 'bar',
                    name: 'Trip Count',
                    marker: { color: '#667eea' },
                    text: counts.map(c => formatNumber(c)),
                    textposition: 'outside'
                };

                const trace2 = {
                    x: types,
                    y: fares,
                    type: 'bar',
                    name: 'Avg Fare',
                    yaxis: 'y2',
                    marker: { color: '#764ba2' },
                    text: fares.map(f => formatCurrency(f)),
                    textposition: 'outside'
                };

                const layout1 = {
                    title: 'Airport vs Regular Trip Comparison',
                    yaxis: { title: 'Trip Count' },
                    yaxis2: {
                        title: 'Average Fare ($)',
                        overlaying: 'y',
                        side: 'right'
                    },
                    height: 400
                };

                Plotly.newPlot('airport-comparison', [trace1, trace2], layout1);

                // Top airport origins - FIXED: Use 'zone' not 'origin_zone'
                const originsResponse = await fetch(`${API_BASE}/api/airport/top-origins?limit=10`);
                const originsData = await originsResponse.json();

                let originsHTML = `
                    <h3>Top 10 Origin Zones for Airport Trips</h3>
                    <table>
                        <tr>
                            <th>Rank</th>
                            <th>Origin Zone</th>
                            <th>Airport Trips</th>
                            <th>Avg Fare</th>
                            <th>Avg Distance</th>
                        </tr>
                `;

                originsData.top_origins.forEach((origin, idx) => {
                    originsHTML += `
                        <tr>
                            <td><strong>${idx + 1}</strong></td>
                            <td>${origin.zone}</td>
                            <td>${formatNumber(origin.trip_count)}</td>
                            <td>${formatCurrency(origin.avg_fare)}</td>
                            <td>${origin.avg_distance} mi</td>
                        </tr>
                    `;
                });

                originsHTML += '</table>';
                document.getElementById('airport-origins').innerHTML = originsHTML;

                // Populate airport zone selectors for comparison
                const allOriginsResponse = await fetch(`${API_BASE}/api/airport/top-origins?limit=100`);
                const allOriginsData = await allOriginsResponse.json();
                populateZoneSelectors(
                    allOriginsData.top_origins.map(o => ({ zone: o.zone })),
                    ['airport-zone1-select', 'airport-zone2-select']
                );

            } catch (error) {
                document.getElementById('airport-comparison').innerHTML =
                    `<div class="error">Error loading airport data: ${error.message}</div>`;
            }
        }

        // Feature 5: OD Flows - ENHANCED with better flow pattern analysis
        async function loadODFlowData() {
            try {
                const response = await fetch(`${API_BASE}/api/od-flows/top-routes?limit=20`);
                const data = await response.json();

                let tableHTML = `
                    <h3>Top 20 Most Popular Routes (Origin ‚Üí Destination)</h3>
                    <table>
                        <tr>
                            <th>Rank</th>
                            <th>Origin Zone</th>
                            <th>Destination Zone</th>
                            <th>Total Trips</th>
                            <th>Avg Fare</th>
                            <th>Avg Distance</th>
                            <th>Avg Duration</th>
                            <th>$/Mile</th>
                        </tr>
                `;

                data.top_routes.forEach((route, idx) => {
                    const farePerMile = (route.avg_fare / route.avg_distance).toFixed(2);
                    tableHTML += `
                        <tr>
                            <td><strong>${idx + 1}</strong></td>
                            <td>${route.origin}</td>
                            <td>${route.destination}</td>
                            <td>${formatNumber(route.trip_count)}</td>
                            <td>${formatCurrency(route.avg_fare)}</td>
                            <td>${route.avg_distance} mi</td>
                            <td>${route.avg_duration_min} min</td>
                            <td>${formatCurrency(farePerMile)}</td>
                        </tr>
                    `;
                });

                tableHTML += '</table>';
                document.getElementById('od-table').innerHTML = tableHTML;

                // Flow pattern analysis - ENHANCED
                const intraZone = data.top_routes.filter(r => r.origin === r.destination).length;
                const crossZone = data.top_routes.filter(r => r.origin !== r.destination).length;

                const shortRoutes = data.top_routes.filter(r => r.avg_distance < 1.5).length;
                const mediumRoutes = data.top_routes.filter(r => r.avg_distance >= 1.5 && r.avg_distance < 3).length;
                const longRoutes = data.top_routes.filter(r => r.avg_distance >= 3).length;

                const avgSpeed = data.top_routes.reduce((sum, r) =>
                    sum + (r.avg_distance / (r.avg_duration_min / 60)), 0) / data.top_routes.length;

                const flowHTML = `
                    <h3>Route Network Analysis</h3>
                    <div class="metric-grid">
                        <div class="metric-box">
                            <div class="value">${intraZone}</div>
                            <div class="label">Intra-Zone Routes (Same Origin/Dest)</div>
                        </div>
                        <div class="metric-box">
                            <div class="value">${crossZone}</div>
                            <div class="label">Cross-Zone Routes</div>
                        </div>
                        <div class="metric-box">
                            <div class="value">${shortRoutes} / ${mediumRoutes} / ${longRoutes}</div>
                            <div class="label">Short / Medium / Long Distance</div>
                        </div>
                        <div class="metric-box">
                            <div class="value">${avgSpeed.toFixed(1)} mph</div>
                            <div class="label">Avg Speed (Top Routes)</div>
                        </div>
                    </div>
                    <p style="margin-top: 15px; color: #666; line-height: 1.8;">
                        <strong>Flow Pattern Insights:</strong><br>
                        ‚Ä¢ <strong>Intra-Zone Dominance:</strong> ${((intraZone/20)*100).toFixed(0)}% of top routes are within same zone, indicating strong local mobility<br>
                        ‚Ä¢ <strong>Distance Distribution:</strong> Short trips (<1.5mi): ${shortRoutes}, Medium (1.5-3mi): ${mediumRoutes}, Long (>3mi): ${longRoutes}<br>
                        ‚Ä¢ <strong>Network Efficiency:</strong> Average speed of ${avgSpeed.toFixed(1)} mph reflects Manhattan traffic conditions and stop patterns
                    </p>
                `;

                document.getElementById('od-flow-analysis').innerHTML = flowHTML;

                // Populate OD zone selectors for comparison - get unique origin zones
                const allRoutesResponse = await fetch(`${API_BASE}/api/od-flows/top-routes?limit=200`);
                const allRoutesData = await allRoutesResponse.json();
                const uniqueOrigins = [...new Set(allRoutesData.top_routes.map(r => r.origin))].map(zone => ({ zone }));
                populateZoneSelectors(uniqueOrigins, ['od-zone1-select', 'od-zone2-select']);

            } catch (error) {
                document.getElementById('od-table').innerHTML =
                    `<div class="error">Error loading OD flow data: ${error.message}</div>`;
            }
        }

        // Feature 6: Vendor Performance - Enhanced comparison
        async function loadVendorData() {
            try {
                const response = await fetch(`${API_BASE}/api/vendors/performance`);
                const data = await response.json();

                // Market share pie chart
                const vendors = data.vendors.map(v => v.vendor_name);
                const shares = data.vendors.map(v => v.market_share_pct);

                const tracePie = {
                    labels: vendors,
                    values: shares,
                    type: 'pie',
                    marker: {
                        colors: ['#667eea', '#764ba2', '#f093fb']
                    },
                    textinfo: 'label+percent',
                    text: shares.map(s => `${s.toFixed(1)}%`),
                    textposition: 'outside'
                };

                const layout1 = {
                    title: 'Vendor Market Share Distribution',
                    height: 400
                };

                Plotly.newPlot('vendor-market', [tracePie], layout1);

                // Performance metrics comparison
                const avgFares = data.vendors.map(v => v.avg_fare);
                const avgDistances = data.vendors.map(v => v.avg_distance);
                const avgDurations = data.vendors.map(v => v.avg_duration_min);

                const trace1 = {
                    x: vendors,
                    y: avgFares,
                    type: 'bar',
                    name: 'Avg Fare ($)',
                    marker: { color: '#667eea' },
                    text: avgFares.map(f => formatCurrency(f)),
                    textposition: 'outside'
                };

                const trace2 = {
                    x: vendors,
                    y: avgDistances,
                    type: 'bar',
                    name: 'Avg Distance (mi)',
                    marker: { color: '#764ba2' },
                    text: avgDistances.map(d => `${d.toFixed(2)} mi`),
                    textposition: 'outside'
                };

                const trace3 = {
                    x: vendors,
                    y: avgDurations,
                    type: 'bar',
                    name: 'Avg Duration (min)',
                    marker: { color: '#f093fb' },
                    text: avgDurations.map(d => `${d.toFixed(1)} min`),
                    textposition: 'outside'
                };

                const layout2 = {
                    title: 'Vendor Performance Metrics Comparison',
                    barmode: 'group',
                    height: 400
                };

                Plotly.newPlot('vendor-performance', [trace1, trace2, trace3], layout2);

            } catch (error) {
                document.getElementById('vendor-market').innerHTML =
                    `<div class="error">Error loading vendor data: ${error.message}</div>`;
            }
        }

        // Feature 7: Payment & Tipping - ENHANCED with all payment types
        async function loadPaymentData() {
            try {
                const response = await fetch(`${API_BASE}/api/payment-tipping/by-payment-type`);
                const data = await response.json();

                const payments = data.payment_types.map(p => p.payment_type);
                const tipPcts = data.payment_types.map(p => p.avg_tip_pct || 0);
                const tipFreqs = data.payment_types.map(p => p.tipping_frequency_pct);
                const tripCounts = data.payment_types.map(p => p.trip_count);
                const pctOfTrips = data.payment_types.map(p => p.pct_of_trips);

                // Payment distribution pie chart
                const tracePie = {
                    labels: payments,
                    values: tripCounts,
                    type: 'pie',
                    marker: {
                        colors: ['#667eea', '#764ba2', '#f093fb', '#4facfe']
                    },
                    textinfo: 'label+percent',
                    text: tripCounts.map(c => formatNumber(c)),
                    textposition: 'outside'
                };

                const layout1 = {
                    title: 'Payment Method Distribution',
                    height: 400
                };

                Plotly.newPlot('payment-distribution', [tracePie], layout1);

                // Comprehensive payment analysis table
                let analysisHTML = `
                    <h3>Payment Method & Tipping Behavior Analysis</h3>
                    <table>
                        <tr>
                            <th>Payment Type</th>
                            <th>Trips</th>
                            <th>% of Total</th>
                            <th>Avg Fare</th>
                            <th>Avg Tip</th>
                            <th>Tip %</th>
                            <th>Tip Frequency</th>
                        </tr>
                `;

                data.payment_types.forEach(p => {
                    analysisHTML += `
                        <tr>
                            <td><strong>${p.payment_type}</strong></td>
                            <td>${formatNumber(p.trip_count)}</td>
                            <td>${p.pct_of_trips.toFixed(2)}%</td>
                            <td>${formatCurrency(p.avg_fare)}</td>
                            <td>${formatCurrency(p.avg_tip)}</td>
                            <td>${p.avg_tip_pct.toFixed(2)}%</td>
                            <td>${p.tipping_frequency_pct.toFixed(2)}%</td>
                        </tr>
                    `;
                });

                analysisHTML += '</table>';

                // Add key insights
                const creditCard = data.payment_types.find(p => p.payment_type === 'Credit card');
                const cash = data.payment_types.find(p => p.payment_type === 'Cash');

                analysisHTML += `
                    <div style="margin-top: 20px; padding: 15px; background: #e8f4fd; border-left: 4px solid #2196F3; border-radius: 4px;">
                        <h4 style="color: #1976D2; margin-bottom: 10px;">üí° Key Behavioral Economics Insights</h4>
                        <p style="color: #555; line-height: 1.8; margin: 0;">
                            ‚Ä¢ <strong>Credit Card Dominance:</strong> ${creditCard.pct_of_trips.toFixed(1)}% of trips use credit cards<br>
                            ‚Ä¢ <strong>Tipping Gap:</strong> Credit card users tip ${creditCard.tipping_frequency_pct.toFixed(1)}% of the time vs. ${cash.tipping_frequency_pct.toFixed(2)}% for cash<br>
                            ‚Ä¢ <strong>Tip Amount:</strong> Credit card tips average ${creditCard.avg_tip_pct.toFixed(1)}% of fare (${formatCurrency(creditCard.avg_tip)})<br>
                            ‚Ä¢ <strong>Driver Income Impact:</strong> Digital payments dramatically increase driver earnings through higher tip frequency and amounts
                        </p>
                    </div>
                `;

                document.getElementById('payment-analysis').innerHTML = analysisHTML;

            } catch (error) {
                document.getElementById('payment-distribution').innerHTML =
                    `<div class="error">Error loading payment data: ${error.message}</div>`;
            }
        }

        // Feature 8: Anomalies - Enhanced with examples
        async function loadAnomalyData() {
            try {
                const response = await fetch(`${API_BASE}/api/anomalies/summary`);
                const data = await response.json();

                const summaryHTML = `
                    <h3>Anomaly Detection Summary</h3>
                    <div class="metric-grid">
                        <div class="metric-box">
                            <div class="value">${formatNumber(data.anomalies.high_fare_per_mile.count)}</div>
                            <div class="label">High Fare/Mile Trips</div>
                        </div>
                        <div class="metric-box">
                            <div class="value">${data.anomalies.high_fare_per_mile.percentage}%</div>
                            <div class="label">Percentage of Total</div>
                        </div>
                        <div class="metric-box">
                            <div class="value">${formatNumber(data.anomalies.no_tip_expensive.count)}</div>
                            <div class="label">No Tip on Expensive Trips</div>
                        </div>
                        <div class="metric-box">
                            <div class="value">${data.anomalies.no_tip_expensive.percentage}%</div>
                            <div class="label">Percentage of Trips >$50</div>
                        </div>
                    </div>
                    <p style="margin-top: 20px; color: #666; line-height: 1.8;">
                        <strong>Anomaly Categories:</strong><br>
                        ‚Ä¢ <strong>High Fare/Mile (>$50/mile):</strong> Indicates surge pricing, traffic delays, or potential data errors<br>
                        ‚Ä¢ <strong>No Tip on Expensive Trips:</strong> Behavioral anomaly suggesting service issues or cash payments<br>
                        ‚Ä¢ <strong>Quality Control:</strong> These flags help identify fraudulent transactions and improve data accuracy
                    </p>
                `;

                document.getElementById('anomaly-summary').innerHTML = summaryHTML;

                // Load example anomalies
                const examplesResponse = await fetch(`${API_BASE}/api/anomalies/high-fare-per-mile?limit=10`);
                const examplesData = await examplesResponse.json();

                let examplesHTML = `
                    <h3>Sample High Fare/Mile Anomalies (Top 10)</h3>
                    <table>
                        <tr>
                            <th>Trip ID</th>
                            <th>Pickup</th>
                            <th>Dropoff</th>
                            <th>Fare</th>
                            <th>Distance</th>
                            <th>$/Mile</th>
                            <th>Duration</th>
                        </tr>
                `;

                examplesData.anomalies.slice(0, 10).forEach(anomaly => {
                    examplesHTML += `
                        <tr>
                            <td>${anomaly.trip_id}</td>
                            <td>${anomaly.pickup_zone}</td>
                            <td>${anomaly.dropoff_zone}</td>
                            <td>${formatCurrency(anomaly.fare_amount)}</td>
                            <td>${anomaly.trip_distance} mi</td>
                            <td><strong>${formatCurrency(anomaly.fare_per_mile)}</strong></td>
                            <td>${anomaly.duration_min} min</td>
                        </tr>
                    `;
                });

                examplesHTML += '</table>';
                document.getElementById('anomaly-examples').innerHTML = examplesHTML;

            } catch (error) {
                document.getElementById('anomaly-summary').innerHTML =
                    `<div class="error">Error loading anomaly data: ${error.message}</div>`;
            }
        }

        // Load all data on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadZoneData();
            loadTemporalData();
            loadFareData();
            loadAirportData();
            loadODFlowData();
            loadVendorData();
            loadPaymentData();
            loadAnomalyData();
        });
    </script>
</body>
</html>
